<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* ìŒì„± ì¸ì‹ ì¤‘ íŒŒí˜• ì• ë‹ˆë©”ì´ì…˜ */
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 18px;
        }
        .bar {
            width: 3px;
            height: 100%;
            background-color: white;
            animation: wave 0.5s ease-in-out infinite alternate;
        }
        @keyframes wave {
            from { transform: scaleY(0.4); }
            to { transform: scaleY(1.2); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * [CONFIG] ì„¤ì •ê°’
         */
        const CONFIG = {
            API_BASE_URL: "http://127.0.0.1:8000",
            ENDPOINT_QUERY: "/query",
            ENDPOINT_VOICE_QUERY: "/voice-query",
            TITLE: "ğŸ¤– RAG AI ì±—ë´‡",
            PLACEHOLDER: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ì„¸ìš”..."
        };

        function App() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const scrollRef = useRef(null);
            
            // ìŒì„± ë…¹ìŒ ê´€ë ¨ ì°¸ì¡°
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
            const handleSend = async (text = input) => {
                if (!text.trim()) return;
                
                const userMsg = { role: 'user', content: text };
                setMessages(prev => [...prev, userMsg]);
                setInput("");
                setLoading(true);

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${CONFIG.ENDPOINT_QUERY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text }),
                    });
                    const data = await response.json();
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: data.answer,
                        sources: data.sources 
                    }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'assistant', content: "âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨" }]);
                } finally {
                    setLoading(false);
                }
            };

            // ìŒì„± ë°ì´í„° ì „ì†¡ (STT + RAG + TTS)
            const sendVoiceFile = async (audioBlob) => {
                setLoading(true);
                const formData = new FormData();
                formData.append('file', audioBlob, 'voice.wav');

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${CONFIG.ENDPOINT_VOICE_QUERY}`, {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();

                    setMessages(prev => [
                        ...prev, 
                        { role: 'user', content: `ğŸ¤ ${data.query}` },
                        { role: 'assistant', content: data.answer, sources: data.sources }
                    ]);

                    if (data.audio_url) {
                        const audio = new Audio(`${CONFIG.API_BASE_URL}${data.audio_url}`);
                        audio.play();
                    }
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'assistant', content: "âš ï¸ ìŒì„± ì¸ì‹ ì²˜ë¦¬ ì‹¤íŒ¨" }]);
                } finally {
                    setLoading(false);
                }
            };

            // ë§ˆì´í¬ í† ê¸€ ë¡œì§
            const toggleListening = async () => {
                if (!isListening) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorderRef.current = new MediaRecorder(stream);
                        audioChunksRef.current = [];

                        mediaRecorderRef.current.ondataavailable = (e) => {
                            if (e.data.size > 0) audioChunksRef.current.push(e.data);
                        };

                        mediaRecorderRef.current.onstop = () => {
                            const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
                            sendVoiceFile(audioBlob);
                            stream.getTracks().forEach(track => track.stop());
                        };

                        mediaRecorderRef.current.start();
                        setIsListening(true);
                    } catch (err) {
                        alert("ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.");
                    }
                } else {
                    mediaRecorderRef.current.stop();
                    setIsListening(false);
                }
            };

            return (
                <div className="flex flex-col h-screen max-w-2xl mx-auto shadow-xl bg-white">
                    {/* Header */}
                    <header className="bg-slate-800 p-4 text-white text-center font-bold text-lg shadow-sm">
                        {CONFIG.TITLE}
                    </header>

                    {/* Chat Area */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {messages.length === 0 && (
                            <div className="text-center text-gray-400 mt-10 text-sm">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
                        )}
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none shadow-sm'}`}>
                                    <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                                    {msg.sources && msg.sources.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-gray-100 text-[10px] text-gray-400 font-medium">
                                            ì¶œì²˜: {msg.sources.join(", ")}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-blue-500 animate-pulse font-medium text-center py-2">ì‘ë‹µ ì²˜ë¦¬ ì¤‘...</div>}
                        <div ref={scrollRef} />
                    </main>

                    {/* Input Area */}
                    <footer className="p-4 bg-white border-t flex items-center gap-3">
                        <button 
                            onClick={toggleListening}
                            className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${isListening ? 'bg-red-500 shadow-lg scale-110' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        >
                            {isListening ? (
                                <div className="voice-wave">
                                    <div className="bar" style={{animationDelay: '0.0s'}}></div>
                                    <div className="bar" style={{animationDelay: '0.1s'}}></div>
                                    <div className="bar" style={{animationDelay: '0.2s'}}></div>
                                    <div className="bar" style={{animationDelay: '0.1s'}}></div>
                                    <div className="bar" style={{animationDelay: '0.0s'}}></div>
                                </div>
                            ) : (
                                <span className="text-xl">ğŸ™ï¸</span>
                            )}
                        </button>
                        <input 
                            className="flex-1 p-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                            placeholder={CONFIG.PLACEHOLDER}
                        />
                        <button 
                            onClick={() => handleSend()}
                            className="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-700 transition-colors"
                        >
                            <span className="text-xl">ğŸš€</span>
                        </button>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
