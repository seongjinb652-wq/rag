<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * [CONFIG] ì„¤ì •ê°’ - ì„œë²„ í™˜ê²½ì— ë§ì¶° ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ì„¸ìš”.
         */
        const CONFIG = {
            API_BASE_URL: "http://127.0.0.1:8000", // ì‹¤ì œ ì„œë²„ ì£¼ì†Œë¡œ ë³€ê²½ ê°€ëŠ¥
            ENDPOINT_QUERY: "/query",
            TITLE: "ğŸ¤– RAG AI ì±—ë´‡",
            PLACEHOLDER: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ì„¸ìš”..."
        };

        function App() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleSend = async (text = input) => {
                if (!text.trim()) return;
                
                const userMsg = { role: 'user', content: text };
                setMessages(prev => [...prev, userMsg]);
                setInput("");
                setLoading(true);

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}${CONFIG.ENDPOINT_QUERY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text }),
                    });
                    const data = await response.json();
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: data.answer,
                        sources: data.sources 
                    }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'assistant', content: "âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (Backend ì‹¤í–‰ í™•ì¸ í•„ìš”)" }]);
                } finally {
                    setLoading(false);
                }
            };

            const toggleListening = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }
                const recognition = new SpeechRecognition();
                recognition.lang = 'ko-KR';
                
                if (!isListening) {
                    recognition.start();
                    setIsListening(true);
                }
                recognition.onresult = (e) => {
                    handleSend(e.results[0][0].transcript);
                    setIsListening(false);
                };
                recognition.onerror = () => setIsListening(false);
                recognition.onend = () => setIsListening(false);
            };

            return (
                <div className="flex flex-col h-screen max-w-2xl mx-auto shadow-xl bg-slate-100">
                    {/* Header */}
                    <header className="bg-slate-800 p-4 text-white text-center font-bold text-lg shadow-sm">
                        {CONFIG.TITLE}
                    </header>

                    {/* Chat Area */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-200">
                        {messages.length === 0 && (
                            <div className="text-center text-gray-400 mt-10 text-sm">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
                        )}
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none shadow-sm'}`}>
                                    <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                                    {msg.sources && msg.sources.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-gray-100 text-[10px] text-gray-400 font-medium">
                                            ì¶œì²˜: {msg.sources.join(", ")}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs text-blue-500 animate-pulse font-medium text-center">ë‹µë³€ ìƒì„± ì¤‘...</div>}
                        <div ref={scrollRef} />
                    </main>

                    {/* Input Area */}
                    <footer className="p-4 bg-white border-t flex items-center gap-3">
                        <button 
                            onClick={toggleListening}
                            className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        >
                            <span className="text-xl">ğŸ™ï¸</span>
                        </button>
                        <input 
                            className="flex-1 p-3 bg-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                            placeholder={CONFIG.PLACEHOLDER}
                        />
                        <button 
                            onClick={() => handleSend()}
                            className="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-700 transition-colors"
                        >
                            <span className="text-xl">ğŸš€</span>
                        </button>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
