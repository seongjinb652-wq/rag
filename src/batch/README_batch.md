# 배치 자동화 (신규/수정/삭제 감지)

## 📌 목표

- ✅ 네이버 클라우드에서 파일 다운로드
- ✅ **신규 파일 처리** (신규)
- ✅ **수정 파일 재처리** (수정 감지 + 반영)
- ✅ **삭제 파일 감지** (안전 차원 미처리)
- ✅ 월간 자동 문서 처리 (배치 50개)
- ✅ 샘플 테스트 (안정성 확인)
- ✅ 진행 상황 실시간 표시
- ✅ 최종 리포트 생성

---

## 🚀 실행 방법

### Step 1: 수동 테스트

```bash
cd src/batch
python setup_batch_scheduler.py
```

### Step 2: 자동 스케줄 (월간)

```bash
# APScheduler로 매월 1일 오전 2시 자동 실행
python schedule_monthly_batch.py
```

### 예상 출력

```
================================================================================
🚀 배치 처리 시작
================================================================================

🔍 파일 스캔 시작...
✅ 스캔 완료: 100개 파일 발견

📊 파일 상태 분류...
   ✨ 신규: file1.pdf
   📝 수정: file2.docx (크기 변경)
   ⚠️ 삭제된 파일 감지: 1개
📊 분류 완료: 신규 50개, 수정 5개, 삭제 1개

⬇️ 파일 다운로드 시작: 55개
   진행: 10/55 다운로드
   진행: 20/55 다운로드
   진행: 30/55 다운로드
   진행: 40/55 다운로드
   진행: 50/55 다운로드
✅ 다운로드 완료: 55개

🧪 샘플 테스트: 5개 파일
✅ 샘플 테스트 통과

📦 배치 처리 시작: 55개 파일

🔄 배치 1: 50개 파일 처리 중...
✅ 배치 1 완료: 50/55 파일, 250개 청크 추가

🔄 배치 2: 5개 파일 처리 중...
✅ 배치 2 완료: 55/55 파일, 25개 청크 추가

✅ 배치 처리 완료: 총 275개 청크 생성

================================================================================
📊 배치 처리 완료 리포트
================================================================================

⏱️ 소요 시간: 52.34초

📈 처리 통계:
   ✓ 스캔 파일: 100개
   ✨ 신규 파일: 50개
   📝 수정 파일: 5개
   ⚠️ 삭제 파일: 1개 (감지만, 미처리)
   ⬇️ 다운로드: 55개
   ✓ 처리 성공: 55개
   ✗ 처리 실패: 0개
   ✓ 생성 청크: 275개

🗓️ 실행 시간:
   시작: 2025-01-26T14:30:00
   종료: 2025-01-26T14:31:52

🔒 보안 주의:
   삭제된 파일 1개가 감지되었습니다.
   데이터 무결성 보호를 위해 벡터 DB에서 제거하지 않았습니다.
   필요시 관리자에게 문의하세요.

================================================================================
```

---

## 🔧 파일 상태 분류

### 1️⃣ 신규 파일 (✨ 처리함)

```
상태: 상태 파일에 없는 파일
처리: ✅ 벡터 DB에 추가

예:
   file1.pdf (새로 업로드됨)
   → 처리 → 250개 청크 생성 → DB 저장
```

### 2️⃣ 수정 파일 (📝 처리함)

```
상태: 파일 크기가 변경된 파일
처리: ✅ 재처리 → 벡터 DB에 추가

감지 방법:
   - 파일 크기 비교
   - 해시값 비교

예:
   file2.docx (100KB → 120KB)
   → 이전 청크 유지 + 새 청크 추가
```

### 3️⃣ 삭제 파일 (⚠️ 미처리)

```
상태: 상태 파일에는 있지만 클라우드에 없는 파일
처리: ⚠️ 감지만 하고 처리 안 함 (보안)

이유:
   - 벡터 DB에서 특정 청크만 제거하기 어려움
   - 데이터 무결성 보호
   - 실수로 인한 삭제 방지

처리 방법:
   1. 리포트에서 삭제 파일 확인
   2. 관리자 판단 후 수동 처리
   3. 필요시 백업에서 복구
```

---

## 💾 상태 파일 (batch_state.json)

```json
{
    "processed_files": {
        "file1.pdf": {
            "modified_time": "2025-01-26T14:30:00",
            "file_hash": "abc123def456xyz...",
            "file_size": 5120,
            "chunks": 250,
            "status": "processed"
        },
        "file2.docx": {
            "modified_time": "2025-01-26T14:35:00",
            "file_hash": "def456xyz789...",
            "file_size": 8192,
            "chunks": 120,
            "status": "processed"
        }
    },
    "last_run": "2025-01-26T14:30:00",
    "total_chunks": 1000
}
```

---

## 🔄 처리 흐름

```
Naver Cloud (100개 파일)
    ↓
[파일 스캔] → 100개 발견
    ↓
[파일 분류]
    ├─ 신규: 50개 ✨
    ├─ 수정: 5개 📝
    └─ 삭제: 1개 ⚠️
    ↓
[다운로드] → 신규 + 수정 55개 다운로드
    ↓
[샘플 테스트] → 5개 확인 ✓
    ↓
[배치 1] → 50개 처리 → 250개 청크
    ↓
[배치 2] → 5개 처리 → 25개 청크
    ↓
[상태 저장] → batch_state.json 업데이트
    ↓
[리포트] → 완료 요약 + 삭제 파일 경고
```

---

## ⚙️ 설정

### 배치 크기 변경

```python
# setup_batch_scheduler.py에서
BATCH_SIZE = 50      # ← 변경 가능 (50, 100, 200)
SAMPLE_SIZE = 5      # ← 테스트 샘플 개수
```

### 자동 스케줄 설정

```python
# schedule_monthly_batch.py (생성 필요)
scheduler.add_job(
    batch_job,
    CronTrigger(
        day=1,      # 매월 1일
        hour=2,     # 오전 2시
        minute=0
    )
)
```

---

## 📊 처리 통계

```
월간 처리량 예시:

시나리오 1 (100건 이내):
   스캔: 100개
   신규: 50개 → 배치 1회 ✅
   수정: 0개
   삭제: 0개
   → 총 275개 청크 생성

시나리오 2 (100건 이상):
   스캔: 150개
   신규: 100개 → 배치 2회 ✅
   수정: 20개
   삭제: 5개 ⚠️
   → 총 500개 청크 생성

배치 실행 횟수:
   - 50개 파일 → 배치 1회
   - 100개 파일 → 배치 2회
   - 150개 파일 → 배치 3회
```

---

## 🐛 트러블슈팅

### 오류: "네이버 클라우드 연결 실패"

**확인:**
```python
# .env 파일에서
NAVER_ACCESS_KEY=...
NAVER_SECRET_KEY=...
NAVER_BUCKET_NAME=...
```

### 오류: "샘플 테스트 실패"

**원인:** 파일 포맷 문제

**확인:**
```bash
# 다운로드 폴더 확인
ls data/downloads/
# 파일이 정상적으로 다운로드되었는지 확인
```

### 파일이 수정되지 않아 보임

**원인:** 파일 크기가 같은 경우

**해결:**
```python
# 더 정확한 감지를 위해 해시값 비교 추가 가능
file_hash = self._calculate_file_hash(file_path)
```

---

## 📁 생성 파일

```
src/batch/
├── setup_batch_scheduler.py    # 메인 배치 처리 ✅ 신규/수정/삭제
├── schedule_monthly_batch.py   # APScheduler (자동 스케줄)
└── README_batch.md             # 이 문서

data/batch_state.json           # 처리 상태 기록 (신규/수정/삭제)
logs/batch.log                  # 실행 로그
logs/batch_report_*.txt         # 실행 리포트
```

---

## ✅ 체크리스트

```
☑️ setup_batch_scheduler.py 실행
☑️ 파일 스캔 확인
☑️ 신규/수정/삭제 파일 분류 확인
☑️ 샘플 테스트 통과
☑️ 배치 처리 완료
☑️ 리포트 생성 확인
☑️ batch_state.json 생성 확인
```

---

## 🔒 보안 고려사항

### 왜 삭제 파일을 처리하지 않나?

```
이유:
1. 벡터 DB에서 특정 청크 제거 어려움
2. 데이터 무결성 보호
3. 실수로 인한 삭제 방지
4. 감시 추적성

대신:
1. 삭제 파일을 리포트에 기록
2. 관리자가 수동으로 판단
3. 필요시 백업에서 복구
```

---

## 🎯 향후 개선 사항

```
Phase 1 (현재): ✅
   - 신규 파일 처리
   - 수정 파일 감지 + 재처리
   - 삭제 파일 감지 (미처리)

Phase 2 (추가 가능):
   - 삭제 파일 추적 (옵션)
   - 벡터 DB 청크 제거 로직
   - 롤백 기능

Phase 3 (고급):
   - 자동 정리 스케줄
   - 버전 관리
   - 변경 이력 추적
```

---

**배치 자동화 완료! 신규/수정 처리 + 삭제 안전 보호! 🚀**
